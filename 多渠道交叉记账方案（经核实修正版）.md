

# 多渠道交叉记账方案（经核实修正版）

## 数据源可行性矩阵

| 渠道 | 可导出 | 格式 | 结构化程度 | 自动解析难度 |
|------|--------|------|-----------|-------------|
| 微信支付 | ✅ | CSV | ⭐⭐⭐⭐⭐ | 极低，现成工具 |
| 支付宝 | ✅ | CSV | ⭐⭐⭐⭐⭐ | 极低，现成工具 |
| 招行信用卡（未出账单）| ✅ | Excel | ⭐⭐⭐⭐ | 低 |
| 招行信用卡（已出账单）| ✅ | PDF | ⭐⭐ | **中高，需 PDF 解析** |
| 招行储蓄卡 | ✅ | PDF / Excel | ⭐⭐~⭐⭐⭐⭐ | 取决于格式 |

## 核心策略调整：以微信/支付宝为主锚点，反向补全银行账单

之前方案是"以银行账单为核心"，但核实后发现 **银行账单（尤其是招行信用卡）的结构化导出能力最差**。

所以策略应该反过来：

### 第一优先级：微信 + 支付宝 CSV（主数据源）

这两份 CSV 是质量最高的数据：
- 有详细商户名（"星巴克中关村店"而不是"财付通"）
- 有「收/付款方式」字段，明确标注了从哪张银行卡扣款
- 格式稳定，社区有成熟的解析工具

**覆盖范围**：你日常线上消费的 70-80% 大概率走这两个渠道。

### 第二优先级：招行信用卡账单（补充 + 校验）

用于补全「不经过微信/支付宝、直接刷信用卡」的消费（如线下 POS 刷卡、境外消费）。

**已出账单处理方案（PDF）**：
- 方案 A：掌上生活补寄 Email 账单 → 如果还是 HTML 格式的 EML，直接解析 HTML 表格
- 方案 B：PDF 账单 → 用 Python 的 pdfplumber / camelot 库提取表格，招行 PDF 账单格式固定，表格提取成功率高
- 方案 C：**每月出账前，从网银大众版下载「未出账单」Excel**，这是结构化数据，不需要解析 PDF

**推荐方案 C**：养成习惯，在每月出账日前一天登录网银，下载未出账单 Excel。这样等于用 Excel 替代了 PDF，绕开了最大的坑。

### 第三优先级：招行储蓄卡流水（兜底校验）

用于确认：
- 微信/支付宝的「余额」或「储蓄卡」扣款是否对得上
- 工资、转账、理财等非消费类流水

## 每月操作流程（约 15 分钟）

### 采集阶段

1. **微信支付**：我 → 服务 → 钱包 → 账单 → 常见问题 → 下载账单 → 个人对账 → 填邮箱（2分钟）
2. **支付宝**：我的 → 账单 → … → 开具交易流水 → 个人对账 → 填邮箱（2分钟）
3. **招行信用卡**（二选一）：
   - 出账前：网银大众版 → 信用卡 → 账户管理 → 未出账单查询 → 下载 Excel（3分钟）
   - 出账后：掌上生活 → 搜索"账单补寄" → 电邮账单 → 申请补寄（3分钟）
4. **招行储蓄卡**：App → 收支明细 → 下载明细 → 填邮箱（2分钟）
5. 去邮箱下载 4 个附件，解压（3分钟）

### 处理阶段（脚本一键跑）

第一轮：合并微信 CSV + 支付宝 CSV → 得到「全量消费明细表」（含商户名 + 扣款银行卡信息）

第二轮：导入招行信用卡数据 → 标记哪些是「直接刷卡」（账单里没有"财付通""支付宝"字样的），哪些是「通过第三方支付」的

第三轮：交叉匹配
- 信用卡账单中「财付通」条目 ↔ 微信 CSV 中「招行信用卡(xxxx)」条目，按日期+金额匹配
- 信用卡账单中「支付宝」条目 ↔ 支付宝 CSV 中「招行信用卡(xxxx)」条目，按日期+金额匹配
- 匹配上的：用微信/支付宝的商户名回填信用卡账单的描述

第四轮：招行储蓄卡流水做交叉校验，确认金额汇总一致

### 输出

一张完整的月度消费表：每笔消费都有「真实商户名」「消费分类」「扣款渠道」「扣款银行卡」。

## 关键风险和应对

| 风险 | 概率 | 应对 |
|------|------|------|
| 招行信用卡 PDF 解析失败 | 低（格式固定） | 用出账前下载 Excel 的方式规避 |
| 微信/支付宝账单导出功能被调整 | 中 | 目前稳定了多年，短期无忧；长期关注 |
| 跨日入账导致匹配不上 | 中（约5-10%） | 匹配窗口放宽到 ±1 天 |
| 微信合并扣款（多笔小额合一笔） | 低（现在很少见） | 同日同渠道金额求和匹配 |
| 招行储蓄卡只能导出 PDF | 中 | pdfplumber 解析，或关注 App 更新 |

## 推荐工具链

- **CSV 解析**：china_bean_importers（pip install china_bean_importers）— 已支持微信、支付宝手机端、招行借记卡
- **PDF 解析**：pdfplumber（Python库）— 招行 PDF 账单格式规整，表格提取可靠
- **交叉匹配**：Pandas（Python）— 按日期+金额做 merge
- **记账输出**：Beancount 或直接输出 Excel，看你偏好

