# Architecture

OpenLedger is a **local-first** tool. It does not try to integrate with any bank/payment provider APIs directly.
Instead, it processes user-exported files (PDF/CSV/XLSX) on your own machine and produces derived artifacts
under `runs/` or `output/`.

## Components

- `web/`: React UI (optional). Talks to the backend over HTTP.
- `openledger/`: Backend (stdlib HTTP server + workflow runner).
- `stages/`: Data processing stages (PDF extract, export normalize, matching, unified output, classify, finalize).
- `tools/`: Developer/maintenance utilities (probe, batch ops).
- `docs/lsp.md`: LSP providers and LangChain config.

## Execution Model (Runs)

Each run has an isolated working directory:

- `runs/<run_id>/inputs/`: uploaded user files (PDF/CSV/XLSX)
- `runs/<run_id>/output/`: derived artifacts generated by each stage
- `runs/<run_id>/config/`: per-run config snapshot (e.g. `classifier.json`)
- `runs/<run_id>/logs/`: stage logs
- `runs/<run_id>/state.json`: run state and stage status

The backend orchestrates pipeline stages by invoking the Python/Node stage modules under `stages/` and streaming output to log files.

## Classifier Config Layering

There are 3 levels (highest priority first):

1. `runs/<run_id>/config/classifier.json` (per-run edits from the UI)
2. `config/classifier.local.json` (local override; ignored by git; recommended for personal tuning)
3. `config/classifier.json` (public default committed in the repo)

The `lsp` field inside the classifier config controls which LLM provider is used by the classification stage.

## Backend HTTP API (High Level)

The backend serves:

- `/api/runs` and `/api/runs/<run_id>`: create/list/load run state
- `/api/runs/<run_id>/upload`: upload input files into `runs/<run_id>/inputs/`
- `/api/runs/<run_id>/start|cancel|reset`: control workflow
- `/api/runs/<run_id>/artifact|preview|logs/*`: fetch artifacts/previews/logs for the UI
- `/api/config/classifier`: read/write global classifier config (writes to `config/classifier.local.json`)
- `/api/sources/support`: input source support matrix (for upload guidance)
- `/api/parsers/pdf/health`: parser health and smoke-check summary
- `/api/capabilities`: aggregated capabilities payload (support matrix + parser health)

## Security / Privacy Boundaries

This repo should never contain:

- `.env` (secrets)
- bills, exported statements, or derived outputs (`bills/`, `output/`, `runs/`, `tmp/`)
- personal classification rules (`config/classifier.local.json`, `config/classifier.private.json`)
- any personal notes (`private/`)

See `.gitignore` and `README.md` for details.
